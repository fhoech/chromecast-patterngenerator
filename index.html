<!--
Copyright (C) 2014 Florian HÃ¶ch.

Based on https://github.com/googlecast/CastHelloText-chrome/chromehellotext.html
Copyright (C) 2014 Google Inc. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--->
<!DOCTYPE html>
<html>
<head>
	<title>Chromecast Pattern Generator Test</title>
	<style type="text/css">
		html, body, #wrapper {
			font-family: sans-serif;
			font-size: x-large;
			height: 100%;
			width: 100%;
			margin: 0;
			padding: 0;
			border: 0;
		}
		#wrapper td {
            line-height: 1.4em;
			text-align: center;
			vertical-align: middle;
		}
		code {
			background: #eee;
			border-radius: 5px;
		}
		code, input {
			font-family: Consolas, Andale Mono, Monaco, Lucida Console, monospace;
		}
		h1 {
			font-weight: normal;
		}
		input {
			border: 2px solid #cccccc;
			border-radius: 5px;
			font-size: xx-large;
			text-align: center;
		}
		input:focus { 
			border-color: #8ecaed;
			box-shadow: 0 0 5px #8ecaed;
			outline: none;
		}
	</style>
	<script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
	<script>
		var applicationID = 'B5C2CBFC',
			namespace = 'urn:x-cast:com.google.cast.patterngenerator',
			session;

		// Call initialization for Cast
		if (!chrome.cast || !chrome.cast.isAvailable)
			setTimeout(initializeCastApi, 1000);

		// Initialization
		function initializeCastApi() {
			var sessionRequest = new chrome.cast.SessionRequest(applicationID),
				apiConfig = new chrome.cast.ApiConfig(sessionRequest,
													  sessionListener,
													  receiverListener);

			chrome.cast.initialize(apiConfig, onInitSuccess, onError);
		};

		// Initialization success callback
		function onInitSuccess() {
			console.log('onInitSuccess');
		}

		// Initialization error callback
		function onError(message) {
			console.log('onError: ' + JSON.stringify(message));
		}

		// Generic success callback
		function onSuccess(message) {
			console.log('onSuccess: ' + message);
		}

		// Session listener during initialization
		function sessionListener(e) {
			console.log('New session ID:' + e.sessionId);
			session = e;
			session.addUpdateListener(sessionUpdateListener);  
			session.addMessageListener(namespace, receiverMessage);
		}

		// Listener for session updates
		function sessionUpdateListener(isAlive) {
			var message = isAlive ? 'Session updated' : 'Session removed';
			message += ': ' + session.sessionId;
			console.log(message);
			if (!isAlive) session = null;
		};

		/**
		 * Utility function to log messages from the receiver
		 * @param {string} namespace The namespace of the message
		 * @param {string} message A message string
		 */
		function receiverMessage(namespace, message) {
			console.log('receiverMessage: ' + namespace + ', ' + message);
		};

		// Receiver listener during initialization
		function receiverListener(e) {
			if( e === 'available' ) console.log('Receiver found');
			else console.log('Receiver list empty');
		}

		// Send data to receiver
		function send(data) {
			if (session) _send(data);
			else {
				chrome.cast.requestSession(function (e) {
					session = e;
					_send(data);
				}, onError);
			}
		}

		function _send(data) {
			var mediaInfo, loadRequest;
			if (data.indexOf('http') === 0 || data.indexOf('data:image') === 0) {
				if (data.indexOf('http') === 0)
					contentType = 'image/' + data.split('.').pop();
				else
					contentType = data.match(/image\/([^;]+)/)[1];
			}
			else
				contentType = 'text/plain';
			mediaInfo = new chrome.cast.media.MediaInfo(data, contentType);
			mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;
			loadRequest = new chrome.cast.media.LoadRequest(mediaInfo);
			session.loadMedia(loadRequest, onSuccess.bind(this, 'Called load: ' + data), onError)
		}
	</script>
</head>
<body>
	<table id="wrapper">
		<tr>
			<td>
				<form method="get" onsubmit="send(document.getElementById('input').value); return false">
					<h1>Chromecast Pattern Generator Test</h1>
					<p>
						Enter an image URL or pattern information in the form<br>
						<code>&lt;foreground&gt;|&lt;background&gt;|&lt;x&gt;|&lt;y&gt;|&lt;width&gt;|&lt;height&gt;</code><br>
						<code>&lt;foreground&gt;</code> and <code>&lt;background&gt;</code> can be hex strings e.g. "#3C0", RGB e.g. "rgb(51, 204, 0)", or image URLs.<br>
						Values other than <code>&lt;foreground&gt;</code> are optional.<br>
						<code>&lt;x&gt;</code> and <code>&lt;y&gt;</code> should be given as relative position 0.0..1.0.<br>
						<code>&lt;width&gt;</code> and <code>&lt;height&gt;</code> should be given as scaling factor 0.0..50.0.
					</p>
					<p>
						<input id="input" type="text" size="30" value="#C30|#808080|.5|.5|1">
					</p>
				</form>
                <p>
                    <button onclick="send(this.innerText); return false">#C30||.5|.5|1</button>
                    <button onclick="send(this.innerText); return false">#3C0||.5|.5|1</button>
                    <button onclick="send(this.innerText); return false">#03C||.5|.5|1</button>
                </p>
			</td>
		</tr>
	</table>
	<script>
		document.getElementById("input").focus();
	</script>
</body>
</html>
