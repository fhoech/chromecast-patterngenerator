<!DOCTYPE html>
<html>
<head>
	<title>Chromecast Pattern Generator Test</title>
	<style type="text/css">
		html, body, #wrapper {
			font-family: sans-serif;
			font-size: x-large;
			height: 100%;
			width: 100%;
			margin: 0;
			padding: 0;
			border: 0;
		}
		#wrapper td {
			text-align: center;
			vertical-align: middle;
		}
		code, input {
			font-family: Consolas, Andale Mono, Monaco, Lucida Console, monospace;
		}
		h1 {
			font-weight: normal;
		}
		input {
			border: 2px solid #cccccc;
			border-radius: 5px;
			font-size: xx-large;
			text-align: center;
		}
		input:focus { 
			border-color: #8ecaed;
			box-shadow: 0 0 5px #8ecaed;
			outline: none;
		}
	</style>
	<script type="text/javascript" src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js"></script>
	<script>
		var applicationID = 'B5C2CBFC',
			namespace = 'urn:x-cast:com.google.cast.patterngenerator',
			session;

		// Call initialization for Cast
		if (!chrome.cast || !chrome.cast.isAvailable)
			setTimeout(initializeCastApi, 1000);

		// Initialization
		function initializeCastApi() {
			var sessionRequest = new chrome.cast.SessionRequest(applicationID),
				apiConfig = new chrome.cast.ApiConfig(sessionRequest,
													  sessionListener,
													  receiverListener);

			chrome.cast.initialize(apiConfig, onInitSuccess, onError);
		};

		// Initialization success callback
		function onInitSuccess() {
			console.log('onInitSuccess');
		}

		// Initialization error callback
		function onError(message) {
			console.log('onError: ' + JSON.stringify(message));
		}

		// Generic success callback
		function onSuccess(message) {
			console.log('onSuccess: ' + message);
		}

		// Session listener during initialization
		function sessionListener(e) {
			console.log('New session ID:' + e.sessionId);
			session = e;
			session.addUpdateListener(sessionUpdateListener);  
			session.addMessageListener(namespace, receiverMessage);
		}

		// Listener for session updates
		function sessionUpdateListener(isAlive) {
			var message = isAlive ? 'Session updated' : 'Session removed';
			message += ': ' + session.sessionId;
			console.log(message);
			if (!isAlive) session = null;
		};

		/**
		 * Utility function to log messages from the receiver
		 * @param {string} namespace The namespace of the message
		 * @param {string} message A message string
		 */
		function receiverMessage(namespace, message) {
			console.log('receiverMessage: ' + namespace + ', ' + message);
		};

		// Receiver listener during initialization
		function receiverListener(e) {
			if( e === 'available' ) console.log('Receiver found');
			else console.log('Receiver list empty');
		}

        // Send data to receiver
		function send(data) {
			if (session) _send(data);
			else {
				chrome.cast.requestSession(function (e) {
					session = e;
					_send(data);
				}, onError);
			}
		}

		function _send(data) {
			var mediaInfo, loadRequest;
			if (data.indexOf('http') === 0 || data.indexOf('data:image/png') === 0)
				contentType = 'image/png';
			else
				contentType = 'text/plain';
			mediaInfo = new chrome.cast.media.MediaInfo(data, contentType);
			mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;
			loadRequest = new chrome.cast.media.LoadRequest(mediaInfo);
			session.loadMedia(loadRequest, onSuccess.bind(this, 'Called load: ' + data), onError)
		}
	</script>
</head>
<body>
	<table id="wrapper">
		<tr>
			<td>
				<form method="get" onsubmit="send(document.getElementById('input').value); return false">
					<h1>Chromecast Pattern Generator Test</h1>
					<p>
						Enter a PNG image URL or pattern information in the form<br>
						<code>&lt;patterncolor&gt;;&lt;backgroundcolor&gt;;&lt;x&gt;;&lt;y&gt;;&lt;width&gt;;&lt;height&gt;</code><br>
						Colors can be hex strings e.g. "#3C0" or RGB e.g. "rgb(51, 204, 0)"<br>
						Values other than patterncolor are optional.<br>
						x, y, width and height should be given in pixels.
					</p>
					<p>
						<input id="input" type="text" size="30" value="#C30;#666;;;500;500">
					</p>
                    <p>
                        <button onclick="send(this.innerText); return false">#C30</button>
                        <button onclick="send(this.innerText); return false">#3C0</button>
                        <button onclick="send(this.innerText); return false">#03C</button>
                    </p>
				</form>
			</td>
		</tr>
	</table>
	<script>
		document.getElementById("input").focus();
	</script>
</body>
</html>
